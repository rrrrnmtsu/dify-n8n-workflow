# CROSS ROPPONGI 月次売上データ転記システム（GAS版）

Google DriveのExcelファイルから全シートのデータを抽出し、新規Google Spreadsheetsに自動転記するシステム。

**作成日**: 2025-10-23
**バージョン**: 1.0.0

---

## 📋 目次

1. [システム概要](#システム概要)
2. [セットアップ手順](#セットアップ手順)
3. [使い方](#使い方)
4. [トラブルシューティング](#トラブルシューティング)
5. [仕様詳細](#仕様詳細)

---

## システム概要

### 機能

- ✅ Google DriveフォルダからExcelファイル（`yyyymmCROSSROPPONGI.xlsx`）を読み込み
- ✅ 1ファイル内の全シート（最大31シート）を自動処理
- ✅ 除外シート設定（「串計」「集計」「マネーフォアード貼付用」）
- ✅ 新規Google Spreadsheetsに6シート構成で転記
- ✅ 手動実行（スプレッドシートのカスタムメニュー）

### 転記先シート構成

| # | シート名 | 内容 |
|---|---------|------|
| 1 | Sheet1 | 基本情報・売上サマリー |
| 2 | 決済別 | エリア別決済データ |
| 3 | VIPリスト | VIP顧客データ |
| 4 | VVIPリスト | VVIP顧客データ |
| 5 | 未収リスト | 未収金データ |
| 6 | 未収回収リスト | 回収データ |

---

## セットアップ手順

### ステップ1: Google Driveフォルダの準備

1. Google Driveで新しいフォルダを作成
2. フォルダを開き、URLから**フォルダID**をコピー
   ```
   https://drive.google.com/drive/folders/【ここがフォルダID】
   ```

### ステップ2: Google Spreadsheetsの作成

1. 新しいGoogle Spreadsheetsを作成
2. 名前を「CROSS ROPPONGI データ転記」などに変更

### ステップ3: Google Apps Scriptの設定

1. スプレッドシートで**拡張機能** > **Apps Script**を開く
2. デフォルトの`Code.gs`を削除
3. 以下の3つのファイルを作成：

#### ファイル1: Code.gs

```javascript
// gas-scripts/Code.gs の内容をコピー
```

#### ファイル2: DataExtractor.gs

1. 左側の「+」ボタン > **スクリプト**をクリック
2. ファイル名を`DataExtractor`に変更
3. 内容を貼り付け：

```javascript
// gas-scripts/DataExtractor.gs の内容をコピー
```

#### ファイル3: SpreadsheetWriter.gs

1. 同様に新しいスクリプトを作成
2. ファイル名を`SpreadsheetWriter`に変更
3. 内容を貼り付け：

```javascript
// gas-scripts/SpreadsheetWriter.gs の内容をコピー
```

### ステップ4: 設定値の変更

`Code.gs`の**CONFIG**セクションを編集：

```javascript
const CONFIG = {
  // ステップ1でコピーしたフォルダIDを貼り付け
  DRIVE_FOLDER_ID: 'YOUR_FOLDER_ID_HERE',  // ← ここを変更

  // その他の設定はデフォルトのまま
  EXCLUDED_SHEETS: ['串計', '集計', 'マネーフォアード貼付用'],
  FILE_PATTERN: /^\d{6}CROSSROPPONGI\.xlsx$/,
  // ...
};
```

### ステップ5: 権限の承認

1. Apps Scriptエディタで**実行** > **関数を実行** > `onOpen`を選択
2. **権限を確認**をクリック
3. Googleアカウントを選択
4. **詳細を表示** > **〜（安全ではないページ）に移動**をクリック
5. **許可**をクリック

### ステップ6: 動作確認

1. スプレッドシートに戻る
2. ページを再読み込み（F5）
3. メニューバーに「📊 CROSS ROPPONGI」が表示されていればOK

---

## 使い方

### 基本操作

1. **Excelファイルの準備**
   - Google Driveの指定フォルダに`202410CROSSROPPONGI.xlsx`などをアップロード

2. **転記の実行**
   - スプレッドシートで**📊 CROSS ROPPONGI** > **🔄 Excelデータを転記**をクリック
   - ファイル確認ダイアログで「はい」をクリック
   - 処理完了まで待機（数分かかる場合があります）

3. **結果の確認**
   - 完了ダイアログに新しいスプレッドシートのURLが表示されます
   - URLをクリックして結果を確認

### 設定の確認

メニュー > **📊 CROSS ROPPONGI** > **⚙️ 設定を表示**で現在の設定を確認できます。

---

## トラブルシューティング

### エラー: 「フォルダIDが正しくありません」

**原因**: `DRIVE_FOLDER_ID`が正しく設定されていない

**解決策**:
1. Google Driveでフォルダを開く
2. URLから正しいフォルダIDをコピー
3. `Code.gs`の`DRIVE_FOLDER_ID`を更新
4. 保存して再実行

---

### エラー: 「対象のExcelファイルが見つかりませんでした」

**原因**: ファイル名が`yyyymmCROSSROPPONGI.xlsx`の形式に一致していない

**解決策**:
- ファイル名を確認（例: `202410CROSSROPPONGI.xlsx`）
- 余分なスペースや全角文字がないか確認

---

### エラー: 「権限が不足しています」

**原因**: Google Drive/Sheets APIの権限が承認されていない

**解決策**:
1. Apps Scriptエディタで**実行** > `onOpen`を手動実行
2. 権限を再承認

---

### 処理が遅い

**原因**: 多数のシート（31シート）を処理している

**対策**:
- 処理中は他の操作を行わない
- 1ファイルあたり3-5分程度かかる場合があります

---

### 除外シートが処理されている

**原因**: シート名が完全一致していない

**確認**:
- Excelのシート名が「串計」「集計」「マネーフォアード貼付用」と**完全一致**しているか
- 前後にスペースがないか

---

## 仕様詳細

### 対応ファイル形式

- **ファイル名**: `yyyymmCROSSROPPONGI.xlsx` (例: `202410CROSSROPPONGI.xlsx`)
- **シート名**: 1, 2, 3, ... 31（数値）
- **除外シート**: 「串計」「集計」「マネーフォアード貼付用」

### データ抽出項目

#### Sheet1（19項目）
- 営業日、総来客数、男性、女性
- 総売上、現金化不足
- セクション別売上（FRONT, CLOAK, LOCKER, BAR1-4, VIP, VVIP, PARTY）
- 未収金、未収回収、VIP詳細JSON

#### 決済別シート（10エリア × 7決済方法 = 70項目）
- エリア: FRONT, CLOAK, LOCKER, BAR1-4, VIP, VVIP, PARTY
- 決済: 現金, クレジット, QUICPAY, AirPayQR, 全東進, JPpoint, 未収

#### VIPリスト（最大23件/日）
- 顧客名（AA5:AA27）
- 金額（AB5:AB27）

#### VVIPリスト（最大24件/日）
- 顧客名（AA29:AA52）
- 金額（AB29:AB52）

#### 未収リスト（最大7件/日）
- 顧客名（H54:I60）
- 金額（J54:J60）
- 担当者（K54:K60）

#### 未収回収リスト（最大7件/日）
- 顧客名（O54:P60）
- 金額（Q54:Q60）
- 担当者（R54:R60）

### 処理フロー

```
1. Google DriveフォルダからExcelファイル一覧取得
2. ユーザーに確認ダイアログ表示
3. Excelファイルを一時的にGoogle Sheetsに変換
4. 各シートを処理:
   a. 除外シートをスキップ
   b. データ抽出（基本情報、決済別、VIP等）
   c. 営業日の算出（yyyymm + シート名）
5. 新規Google Spreadsheetsを作成
6. 6シートにデータ転記
7. 一時ファイルを削除
8. 完了通知表示
```

### 制限事項

- **処理時間**: 1ファイルあたり3-5分程度
- **最大シート数**: 31シート/ファイル
- **Google Apps Scriptの実行時間制限**: 6分
  - 超過する場合は、ファイルを分割して処理

---

## バージョン履歴

### v1.0.0 (2025-10-23)
- 初版リリース
- Google Drive連携
- 6シート構成での転記
- 手動実行機能

---

## サポート

問題が解決しない場合は、以下の情報を確認してください：

1. **ログの確認**
   - Apps Scriptエディタ > **実行ログ**で詳細エラーを確認

2. **設定の確認**
   - `DRIVE_FOLDER_ID`が正しいか
   - ファイル名が`yyyymmCROSSROPPONGI.xlsx`形式か
   - 除外シート名が完全一致しているか

3. **権限の確認**
   - Google Drive/Sheets APIの権限が承認されているか

---

**作成者**: Claude Code
**ライセンス**: MIT
**最終更新**: 2025-10-23
