{
  "name": "Sales Report Complete Workflow (AI Direct)",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "seconds",
              "secondsInterval": 30
            }
          ]
        }
      },
      "id": "schedule-trigger",
      "name": "Schedule Trigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [240, 400]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.telegram.org/bot{{ $env.TELEGRAM_BOT_TOKEN }}/getUpdates",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"offset\": {{ $execution.customData.get('last_update_id') || 0 }},\n  \"timeout\": 25,\n  \"allowed_updates\": [\"message\"]\n}",
        "options": {}
      },
      "id": "get-updates",
      "name": "Get Telegram Updates",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [460, 400]
    },
    {
      "parameters": {
        "jsCode": "// Telegram getUpdatesã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å‡¦ç†\nconst response = $input.first().json;\n\nif (!response.ok || !response.result || response.result.length === 0) {\n  return [];\n}\n\nconst updates = response.result;\nconst processedItems = [];\nconst allowedChatId = parseInt(process.env.TELEGRAM_CHAT_ID);\n\nfor (const update of updates) {\n  const message = update.message;\n  \n  if (message && message.document) {\n    const chatId = message.chat.id;\n    \n    if (chatId === allowedChatId) {\n      const document = message.document;\n      const fileName = document.file_name;\n      const fileExtension = fileName.split('.').pop().toLowerCase();\n      \n      if (['xlsx', 'xls', 'pdf'].includes(fileExtension)) {\n        // ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰æ—¥ä»˜ã‚’æŠ½å‡º\n        const dateMatch = fileName.match(/(\\d{4})[-._ ]?(\\d{2})[-._ ]?(\\d{2})/);\n        let reportDate;\n        if (dateMatch) {\n          reportDate = `${dateMatch[1]}-${dateMatch[2]}-${dateMatch[3]}`;\n        } else {\n          reportDate = new Date().toISOString().split('T')[0];\n        }\n        \n        processedItems.push({\n          json: {\n            update_id: update.update_id,\n            message_id: message.message_id,\n            chat_id: chatId,\n            chat_name: message.chat.title,\n            file_id: document.file_id,\n            file_name: fileName,\n            file_type: fileExtension,\n            file_size: document.file_size,\n            mime_type: document.mime_type,\n            from_user: message.from.first_name || message.from.username,\n            from_user_id: message.from.id,\n            from_username: message.from.username || '',\n            report_date: reportDate,\n            received_at: new Date(message.date * 1000).toISOString()\n          }\n        });\n      }\n    }\n  }\n}\n\n// offsetã‚’æ›´æ–°\nif (updates.length > 0) {\n  const lastUpdateId = updates[updates.length - 1].update_id;\n  $execution.customData.set('last_update_id', lastUpdateId + 1);\n}\n\nreturn processedItems;"
      },
      "id": "process-updates",
      "name": "Filter Sales Reports",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [680, 400]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=https://api.telegram.org/bot{{ $env.TELEGRAM_BOT_TOKEN }}/getFile?file_id={{ $json.file_id }}",
        "options": {}
      },
      "id": "get-file-path",
      "name": "Get File Path",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [900, 400]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=https://api.telegram.org/file/bot{{ $env.TELEGRAM_BOT_TOKEN }}/{{ $json.result.file_path }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "id": "download-file",
      "name": "Download File",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1120, 400]
    },
    {
      "parameters": {
        "jsCode": "// PDFã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡ºï¼ˆç°¡æ˜“ç‰ˆï¼‰\n// å®Ÿç’°å¢ƒã§ã¯pdf-parseãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã™ã‚‹ã‹ã€\n// Claude/OpenAI Vision APIã«PDFã‚’ç›´æ¥é€ä¿¡\n\nconst item = $input.first();\nconst binary = item.binary;\nconst fileData = $('Filter Sales Reports').item.json;\n\n// PDFã®å ´åˆã¯ãƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿ã‚’Base64ã«å¤‰æ›\nlet pdfBase64;\nif (binary && binary.data) {\n  pdfBase64 = binary.data.toString('base64');\n}\n\nreturn [{\n  json: {\n    ...fileData,\n    pdf_base64: pdfBase64,\n    // ç°¡æ˜“çš„ãªãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡ºï¼ˆå®Ÿéš›ã¯OCRã‚„PDFãƒ‘ãƒ¼ã‚µãƒ¼ã‚’ä½¿ç”¨ï¼‰\n    pdf_text: \"PDF content extraction required\"\n  },\n  binary: binary\n}];"
      },
      "id": "extract-pdf-text",
      "name": "Prepare PDF Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1340, 400]
    },
    {
      "parameters": {
        "jsCode": "// ===========================================\n// Sales Report PDF Parser - AI Direct Call\n// ===========================================\n\nconst SYSTEM_PROMPT = `ã‚ãªãŸã¯å£²ä¸Šæ—¥å ±ã‹ã‚‰æƒ…å ±ã‚’æŠ½å‡ºã™ã‚‹å°‚é–€AIã§ã™ã€‚\n\n# å½¹å‰²\nPDFã¾ãŸã¯Excelãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’æ­£ç¢ºã«æŠ½å‡ºã—ã€æ§‹é€ åŒ–ã•ã‚ŒãŸJSONã§è¿”ã—ã¾ã™ã€‚\n\n# æŠ½å‡ºãƒ«ãƒ¼ãƒ«\n\n1. **å–¶æ¥­æ—¥ã®æŠ½å‡º**\n   - ãƒ‘ã‚¿ãƒ¼ãƒ³: YYYYå¹´MMæœˆDDæ—¥ã€YYYYMMDD\n   - è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ: ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰æ¨æ¸¬\n   - å½¢å¼: YYYY-MM-DD\n\n2. **æ¥å®¢æ•°ã®æŠ½å‡º**\n   - ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: \"ç”·æ€§\", \"å¥³æ€§\", \"äººæ•°\"\n   - åˆè¨ˆã¯è‡ªå‹•è¨ˆç®—ã‚’ç¢ºèª\n\n3. **å£²ä¸Šé‡‘é¡ã®æŠ½å‡º**\n   - ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: \"ç·å£²ä¸Š\", \"å–¶æ¥­åˆè¨ˆ\", \"ãƒ•ãƒ­ã‚¢\", \"VIP\", \"PARTY\"\n   - ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã®æ•°å€¤ã‚’æ­£è¦åŒ–\n   - Â¥ãƒãƒ¼ã‚¯ã‚’é™¤å»\n\n4. **ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼**\n   - æ—¥ä»˜ã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯\n   - é‡‘é¡ã®è² æ•°ãƒã‚§ãƒƒã‚¯\n   - å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å­˜åœ¨ç¢ºèª\n\n# å‡ºåŠ›å½¢å¼\n\nå¿…ãšJSONå½¢å¼ã®ã¿ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼ˆãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚„ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã¯ä¸è¦ï¼‰ï¼š\n\n{\n  \"business_date\": \"YYYY-MM-DD\",\n  \"male_count\": æ•°å€¤,\n  \"female_count\": æ•°å€¤,\n  \"total_customer_count\": æ•°å€¤,\n  \"section_a_sales\": æ•°å€¤,\n  \"section_b_sales\": æ•°å€¤,\n  \"section_c_sales\": æ•°å€¤,\n  \"other_sales\": æ•°å€¤,\n  \"total_sales\": æ•°å€¤,\n  \"confidence\": \"high|medium|low\",\n  \"notes\": \"æŠ½å‡ºæ™‚ã®æ³¨æ„äº‹é …\"\n}\n\n# ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°\n\n- ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ: null ã‚’è¿”ã™\n- ä¿¡é ¼åº¦ãŒä½ã„å ´åˆ: \"confidence\": \"low\" ã‚’è¨­å®š\n- ç•°å¸¸å€¤ã‚’æ¤œå‡ºã—ãŸå ´åˆ: notes ã«è¨˜è¼‰`;\n\n// å…¥åŠ›ãƒ‡ãƒ¼ã‚¿å–å¾—\nconst inputData = $input.first().json;\nconst fileName = inputData.file_name || 'unknown';\nconst fileType = inputData.file_type || 'pdf';\nconst pdfBase64 = inputData.pdf_base64;\n\n// ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆ\nconst userPrompt = `ä»¥ä¸‹ã®PDFãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ï¼š\n\nãƒ•ã‚¡ã‚¤ãƒ«å: ${fileName}\nãƒ•ã‚¡ã‚¤ãƒ«ç¨®é¡: ${fileType}\n\nPDFã®å†…å®¹ã‚’è§£æã—ã¦ã€æ§‹é€ åŒ–ã•ã‚ŒãŸJSONã‚’è¿”ã—ã¦ãã ã•ã„ã€‚`;\n\n// APIé¸æŠ\nconst openaiKey = process.env.OPENAI_API_KEY;\nconst anthropicKey = process.env.ANTHROPIC_API_KEY;\n\nlet result;\nlet apiUsed;\n\nif (anthropicKey && pdfBase64) {\n  // Anthropic Claude Vision APIä½¿ç”¨ï¼ˆPDFã‚’ç›´æ¥é€ä¿¡ï¼‰\n  console.log('Using Anthropic Claude Vision API...');\n  \n  const response = await fetch('https://api.anthropic.com/v1/messages', {\n    method: 'POST',\n    headers: {\n      'x-api-key': anthropicKey,\n      'anthropic-version': '2023-06-01',\n      'Content-Type': 'application/json'\n    },\n    body: JSON.stringify({\n      model: 'claude-3-5-sonnet-20241022',\n      max_tokens: 2048,\n      temperature: 0.1,\n      system: SYSTEM_PROMPT,\n      messages: [\n        {\n          role: 'user',\n          content: [\n            {\n              type: 'document',\n              source: {\n                type: 'base64',\n                media_type: 'application/pdf',\n                data: pdfBase64\n              }\n            },\n            {\n              type: 'text',\n              text: userPrompt\n            }\n          ]\n        }\n      ]\n    })\n  });\n\n  if (!response.ok) {\n    throw new Error(`Anthropic API Error: ${response.status} ${await response.text()}`);\n  }\n\n  const data = await response.json();\n  const content = data.content[0].text;\n\n  // JSONè§£æ\n  const jsonMatch = content.match(/\\{[\\s\\S]*\\}/);\n  if (!jsonMatch) {\n    throw new Error('No JSON found in response');\n  }\n  result = JSON.parse(jsonMatch[0]);\n  apiUsed = 'anthropic-vision';\n\n} else if (openaiKey) {\n  // OpenAI APIãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆãƒ†ã‚­ã‚¹ãƒˆãƒ™ãƒ¼ã‚¹ï¼‰\n  console.log('Using OpenAI API (text-based fallback)...');\n  \n  const response = await fetch('https://api.openai.com/v1/chat/completions', {\n    method: 'POST',\n    headers: {\n      'Authorization': `Bearer ${openaiKey}`,\n      'Content-Type': 'application/json'\n    },\n    body: JSON.stringify({\n      model: 'gpt-4o',\n      messages: [\n        { role: 'system', content: SYSTEM_PROMPT },\n        { role: 'user', content: `${userPrompt}\\n\\nâ€»PDFãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡ºãŒå¿…è¦ã§ã™` }\n      ],\n      temperature: 0.1,\n      response_format: { type: 'json_object' }\n    })\n  });\n\n  if (!response.ok) {\n    throw new Error(`OpenAI API Error: ${response.status} ${await response.text()}`);\n  }\n\n  const data = await response.json();\n  const content = data.choices[0].message.content;\n  result = JSON.parse(content);\n  apiUsed = 'openai';\n\n} else {\n  throw new Error('No API key found. Set OPENAI_API_KEY or ANTHROPIC_API_KEY in environment variables');\n}\n\n// ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼\nif (result.male_count !== null && result.female_count !== null) {\n  const expectedTotal = (result.male_count || 0) + (result.female_count || 0);\n  if (result.total_customer_count !== expectedTotal) {\n    result.total_customer_count = expectedTotal;\n  }\n}\n\n// å‡ºåŠ›\nreturn [{\n  json: {\n    ...inputData,\n    parsed_data: result,\n    api_used: apiUsed,\n    parsed_at: new Date().toISOString()\n  }\n}];"
      },
      "id": "parse-with-ai",
      "name": "Parse with AI",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1560, 400]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO sales_data (\n  sales_date,\n  male_count,\n  female_count,\n  section_a_sales,\n  section_b_sales,\n  section_c_sales,\n  other_sales,\n  total_sales,\n  raw_data,\n  source_file\n) VALUES (\n  '{{ $json.parsed_data.business_date }}',\n  {{ $json.parsed_data.male_count || 'NULL' }},\n  {{ $json.parsed_data.female_count || 'NULL' }},\n  {{ $json.parsed_data.section_a_sales || 'NULL' }},\n  {{ $json.parsed_data.section_b_sales || 'NULL' }},\n  {{ $json.parsed_data.section_c_sales || 'NULL' }},\n  {{ $json.parsed_data.other_sales || 'NULL' }},\n  {{ $json.parsed_data.total_sales || 'NULL' }},\n  '{{ JSON.stringify($json.parsed_data) }}',\n  '{{ $json.file_name }}'\n)\nON CONFLICT (sales_date) DO UPDATE SET\n  male_count = EXCLUDED.male_count,\n  female_count = EXCLUDED.female_count,\n  section_a_sales = EXCLUDED.section_a_sales,\n  section_b_sales = EXCLUDED.section_b_sales,\n  section_c_sales = EXCLUDED.section_c_sales,\n  other_sales = EXCLUDED.other_sales,\n  total_sales = EXCLUDED.total_sales,\n  raw_data = EXCLUDED.raw_data,\n  source_file = EXCLUDED.source_file,\n  updated_at = CURRENT_TIMESTAMP\nRETURNING *;",
        "options": {}
      },
      "id": "save-to-database",
      "name": "Save to Database",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [1780, 400],
      "credentials": {
        "postgres": {
          "id": "postgres-sales-db",
          "name": "PostgreSQL - Sales Database"
        }
      }
    },
    {
      "parameters": {
        "resource": "message",
        "operation": "sendMessage",
        "chatId": "={{ $('Filter Sales Reports').item.json.chat_id }}",
        "text": "=âœ… å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸï¼\\n\\nğŸ“Š **å£²ä¸Šãƒ‡ãƒ¼ã‚¿**\\nğŸ“… å–¶æ¥­æ—¥: {{ $('Parse with AI').item.json.parsed_data.business_date }}\\nğŸ‘¥ æ¥å®¢æ•°: {{ $('Parse with AI').item.json.parsed_data.total_customer_count }}å\\nã€€â”” ç”·æ€§: {{ $('Parse with AI').item.json.parsed_data.male_count }}å\\nã€€â”” å¥³æ€§: {{ $('Parse with AI').item.json.parsed_data.female_count }}å\\nğŸ’° ç·å£²ä¸Š: Â¥{{ Number($('Parse with AI').item.json.parsed_data.total_sales).toLocaleString() }}\\n\\nğŸ¢ **ã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆ¥å£²ä¸Š**\\nã€€â€¢ ãƒ•ãƒ­ã‚¢: Â¥{{ Number($('Parse with AI').item.json.parsed_data.section_a_sales || 0).toLocaleString() }}\\nã€€â€¢ VIP: Â¥{{ Number($('Parse with AI').item.json.parsed_data.section_b_sales || 0).toLocaleString() }}\\nã€€â€¢ PARTY: Â¥{{ Number($('Parse with AI').item.json.parsed_data.section_c_sales || 0).toLocaleString() }}\\n\\nğŸ’¾ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã—ã¾ã—ãŸ",
        "additionalFields": {}
      },
      "id": "send-success",
      "name": "Send Success Message",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [2000, 400],
      "credentials": {
        "telegramApi": {
          "id": "telegram-bot-cross-logbot",
          "name": "Telegram Bot - cross_logbot"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO error_logs (\n  error_type,\n  error_message,\n  file_name,\n  telegram_message_id,\n  raw_error_data\n) VALUES (\n  'PROCESSING_ERROR',\n  '{{ $json.error.message }}',\n  '{{ $('Filter Sales Reports').item.json.file_name }}',\n  {{ $('Filter Sales Reports').item.json.message_id }},\n  '{{ JSON.stringify($json.error) }}'\n) RETURNING *;",
        "options": {}
      },
      "id": "log-error",
      "name": "Log Error to DB",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [1780, 600],
      "credentials": {
        "postgres": {
          "id": "postgres-sales-db",
          "name": "PostgreSQL - Sales Database"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "resource": "message",
        "operation": "sendMessage",
        "chatId": "={{ $('Filter Sales Reports').item.json.chat_id }}",
        "text": "=âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ\\n\\nğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«: {{ $('Filter Sales Reports').item.json.file_name }}\\nâŒ ã‚¨ãƒ©ãƒ¼: å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã®æŠ½å‡ºã«å¤±æ•—ã—ã¾ã—ãŸ\\n\\nğŸ’¡ ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„",
        "additionalFields": {}
      },
      "id": "send-error",
      "name": "Send Error Message",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [2000, 600],
      "credentials": {
        "telegramApi": {
          "id": "telegram-bot-cross-logbot",
          "name": "Telegram Bot - cross_logbot"
        }
      }
    }
  ],
  "connections": {
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "Get Telegram Updates",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Telegram Updates": {
      "main": [
        [
          {
            "node": "Filter Sales Reports",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter Sales Reports": {
      "main": [
        [
          {
            "node": "Get File Path",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get File Path": {
      "main": [
        [
          {
            "node": "Download File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download File": {
      "main": [
        [
          {
            "node": "Prepare PDF Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare PDF Data": {
      "main": [
        [
          {
            "node": "Parse with AI",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse with AI": {
      "main": [
        [
          {
            "node": "Save to Database",
            "type": "main",
            "index": 0
          }
        ]
      ],
      "error": [
        [
          {
            "node": "Log Error to DB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save to Database": {
      "main": [
        [
          {
            "node": "Send Success Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Error to DB": {
      "main": [
        [
          {
            "node": "Send Error Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": ""
  },
  "staticData": {},
  "tags": [
    {
      "name": "sales-report"
    },
    {
      "name": "ai-powered"
    },
    {
      "name": "production"
    }
  ],
  "triggerCount": 0,
  "updatedAt": "2025-10-21T00:00:00.000Z",
  "versionId": "1"
}
